<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Work Logger</title>
  <link rel="apple-touch-icon" href="Electrical-Transparent-Background.png">
  <style>
    :root {
      --primary-bg: #f4f4f4;
      --card-bg: #fff;
      --text-color: #1e1e1e;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.1);
      --settings-bg: #fff3cd;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      background: var(--primary-bg); 
      color: var(--text-color);
      margin: 0; 
      padding: 20px; 
    }
    body.dark-mode {
      --primary-bg: #1e1e1e;
      --card-bg: #2c2c2e;
      --text-color: #f5f5f7;
      --border-color: #444;
      --shadow-color: rgba(0,0,0,0.4);
      --settings-bg: #3a3a3c;
    }
    h1 { text-align: center; }
    .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px var(--shadow-color); margin-bottom: 20px; }
    .controls { display: flex; justify-content: space-around; flex-wrap: wrap; }
    button { padding: 12px 15px; margin: 5px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; flex-grow: 1; }
    .start { background-color: #34c759; color: white; }
    .stop { background-color: #ff3b30; color: white; }
    .manual { background-color: #007aff; color: white; }
    .edit { background-color: #ff9500; color: white; }
    .delete { background-color: #ff2d55; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--border-color); text-align: left; }
    th { font-size: 14px; color: #8e8e93; }
    .settings { background: var(--settings-bg); padding: 15px; border-radius: 12px; }
    .settings label { display: block; margin-bottom: 10px; }
    .settings input[type="number"], .settings input[type="checkbox"] { margin-right: 5px; }

    @media screen and (max-width: 600px) {
      table thead { display: none; }
      table, table tbody, table tr, table td { display: block; width: 100%; }
      table tr { background: var(--card-bg); border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px var(--shadow-color); border: 1px solid var(--border-color); }
      table td { text-align: right; padding-left: 50%; position: relative; border-bottom: 1px solid var(--border-color); }
      table td:last-child { border-bottom: none; }
      table td::before { content: attr(data-label); position: absolute; left: 15px; width: calc(50% - 30px); text-align: left; font-weight: bold; color: var(--text-color); }
    }
  </style>
</head>
<body>

  <h1>Work Logger</h1>

  <div class="card">
    <div class="controls">
      <button class="start" onclick="startShift()">Start Work</button>
      <button class="stop" onclick="stopShift()">Stop Work</button>
      <button class="manual" onclick="manualEntry()">Manual Entry</button>
    </div>
    <p id="currentShift" style="text-align: center; margin-top: 15px;"></p>
  </div>

  <div class="card">
    <h2>Shift Log</h2>
    <div id="shiftLog">Loading...</div>
  </div>

  <div class="card settings">
    <label>Hourly Rate: $<input type="number" id="hourlyRate" value="0" onchange="saveSettings()"></label>
    <label><input type="checkbox" id="darkToggle" onchange="toggleDarkMode()"> Dark Mode</label>
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="exportText()">Export Text</button>
    <button onclick="copyToClipboard()">Copy to Clipboard</button>
    <button class="delete" onclick="clearLogs()">Clear All Logs</button>
  </div>

  <script>
    // --- ⬇️ PASTE YOUR GOOGLE SCRIPT URL HERE ⬇️ ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyl1OzSYlgK2MR0JyVL9zMMQF427tCGDweYFirJ0jaGncxO3VSRD1rz5YU_BlJPN2CYg/exec';
    // --- ⬆️ PASTE YOUR GOOGLE SCRIPT URL HERE ⬆️ ---

    let currentShift = null;
    let shiftLog = [];
    let settings = {};

    function loadData() {
      try {
        const storedShift = localStorage.getItem('currentShift');
        if (storedShift) currentShift = JSON.parse(storedShift);
      } catch (e) { console.error("Could not parse currentShift data, resetting.", e); currentShift = null; }

      try {
        const storedLog = localStorage.getItem('shiftLog');
        if (storedLog) {
          const parsedLog = JSON.parse(storedLog);
          shiftLog = Array.isArray(parsedLog) ? parsedLog : [];
        }
      } catch (e) { console.error("Could not parse shiftLog data, resetting.", e); shiftLog = []; }
      
      try {
        const storedSettings = localStorage.getItem('workLoggerSettings');
        settings = storedSettings ? JSON.parse(storedSettings) : { hourlyRate: 0, darkMode: false };
      } catch (e) { console.error("Could not parse settings, resetting.", e); settings = { hourlyRate: 0, darkMode: false }; }
    }
    
    function applySettings() {
        document.getElementById('hourlyRate').value = settings.hourlyRate || 0;
        const darkModeToggle = document.getElementById('darkToggle');
        if (settings.darkMode) {
            document.body.classList.add('dark-mode');
            darkModeToggle.checked = true;
        } else {
            document.body.classList.remove('dark-mode');
            darkModeToggle.checked = false;
        }
    }
    
    function saveSettings() {
        settings.hourlyRate = document.getElementById('hourlyRate').value;
        localStorage.setItem('workLoggerSettings', JSON.stringify(settings));
        renderShiftLog();
    }

    function saveLogs() {
      localStorage.setItem('shiftLog', JSON.stringify(shiftLog));
    }

    function saveCurrent() {
      localStorage.setItem('currentShift', JSON.stringify(currentShift));
    }

    // --- NEW: Function to send data to Google Sheets ---
    async function syncShiftToGoogle(shiftData) {
      if (!SCRIPT_URL.startsWith('https://')) {
        console.warn('Google Script URL is not set. Skipping sync.');
        return;
      }

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'cors', // Required for cross-origin requests
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(shiftData)
        });
        const result = await response.json();
        console.log('Google Sync Success:', result);
      } catch (error) {
        console.error('Google Sync Error:', error);
        alert('Failed to sync shift to Google Sheet. Check console for details.');
      }
    }

    function startShift() {
      if (currentShift) return alert("Shift already in progress.");
      const site = prompt("Enter job site:");
      if (!site) return;
      currentShift = { id: Date.now(), date: new Date().toISOString().split('T')[0], site, start: new Date().toISOString(), end: null, total: null, notes: '', paid: false, tag: '' };
      saveCurrent();
      renderCurrentShiftStatus();
    }

    function stopShift() {
      if (!currentShift) return alert("No active shift.");
      currentShift.end = new Date().toISOString();
      const diff = new Date(currentShift.end) - new Date(currentShift.start);
      const mins = Math.floor(diff / 60000);
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      currentShift.total = `${h}h ${m}m`;
      currentShift.notes = prompt("Add notes for this shift:", "") || '';
      shiftLog.unshift(currentShift);
      saveLogs();
      syncShiftToGoogle(currentShift); // --- MODIFIED: Sync on stop
      currentShift = null;
      saveCurrent();
      renderCurrentShiftStatus();
      renderShiftLog();
    }

    function manualEntry() {
      const date = prompt("Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
      if (!date) return;
      const site = prompt("Site:");
      if (!site) return;
      const start = prompt("Start Time (HH:MM 24-hour format):");
      if (!start) return;
      const end = prompt("End Time (HH:MM 24-hour format):");
      if (!end) return;
      
      const s = new Date(`${date}T${start}`);
      const e = new Date(`${date}T${end}`);
      if (isNaN(s) || isNaN(e) || e < s) return alert("Invalid date or time entered.");

      const diff = e - s;
      const mins = Math.floor(diff / 60000);
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      
      const entry = { id: Date.now(), date, site, start: s.toISOString(), end: e.toISOString(), total: `${h}h ${m}m`, notes: prompt("Notes?") || '', paid: false, tag: '', manual: true };
      shiftLog.unshift(entry);
      saveLogs();
      syncShiftToGoogle(entry); // --- MODIFIED: Sync on manual entry
      renderShiftLog();
    }
    
    function formatTime(isoString) {
        if (!isoString) return '';
        return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function renderShiftLog() {
      const container = document.getElementById('shiftLog');
      const rate = parseFloat(document.getElementById('hourlyRate').value || 0);
      
      if(shiftLog.length === 0) {
        container.innerHTML = "<p>No shifts logged yet.</p>";
        return;
      }
      
      let html = '<table><thead><tr><th>Date</th><th>Site</th><th>Time</th><th>Total</th><th>Paid</th><th>Earnings</th><th>Actions</th></tr></thead><tbody>';
      shiftLog.forEach(s => {
        let totalHours = 0;
        if (s.total) {
            const h_match = s.total.match(/(\d+)h/);
            const m_match = s.total.match(/(\d+)m/);
            const hours = h_match ? parseInt(h_match[1]) : 0;
            const mins = m_match ? parseInt(m_match[1]) : 0;
            totalHours = hours + mins / 60;
        }
        const earnings = (totalHours * rate).toFixed(2);
        
        html += `<tr>
          <td data-label="Date">${s.date}</td>
          <td data-label="Site">${s.site}</td>
          <td data-label="Time">${formatTime(s.start)} - ${formatTime(s.end)}</td>
          <td data-label="Total">${s.total || 'N/A'}</td>
          <td data-label="Paid"><input type="checkbox" ${s.paid ? 'checked' : ''} onchange="togglePaid(${s.id})"></td>
          <td data-label="Earnings">$${earnings}</td>
          <td data-label="Actions"><button class='edit' onclick="editEntry(${s.id})">Edit</button> <button class='delete' onclick="deleteEntry(${s.id})">Del</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function renderCurrentShiftStatus() {
       document.getElementById('currentShift').textContent = currentShift ? `Current shift started at ${formatTime(currentShift.start)}` : 'No active shift.';
    }

    function editEntry(id) {
        const entry = shiftLog.find(e => e.id === id);
        if (!entry) return;
        entry.site = prompt("Edit Site:", entry.site) || entry.site;
        entry.notes = prompt("Edit Notes:", entry.notes) || entry.notes;
        saveLogs();
        renderShiftLog();
        // Note: Syncing edits is a future enhancement. This only updates the local log.
    }

    function deleteEntry(id) {
      if (!confirm("Are you sure you want to delete this entry?")) return;
      shiftLog = shiftLog.filter(e => e.id !== id);
      saveLogs();
      renderShiftLog();
    }

    function togglePaid(id) {
      const s = shiftLog.find(e => e.id === id);
      if (s) { s.paid = !s.paid; saveLogs(); }
    }
    
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        settings.darkMode = document.body.classList.contains('dark-mode');
        localStorage.setItem('workLoggerSettings', JSON.stringify(settings));
    }
    
    function exportCSV() {
      let csv = 'Date,Site,Start Time,End Time,Total Hours,Notes,Paid\n';
      shiftLog.forEach(s => { csv += [s.date, s.site, formatTime(s.start), formatTime(s.end), s.total, `"${s.notes}"`, s.paid].join(',') + '\n'; });
      download('worklog.csv', csv);
    }

    function exportText() {
      let txt = 'Work Log Export\n==============\n';
      shiftLog.forEach(s => { txt += `${s.date} | ${s.site} | ${formatTime(s.start)} - ${formatTime(s.end)} (${s.total}) | Notes: ${s.notes} | ${s.paid ? 'Paid' : 'Unpaid'}\n`; });
      download('worklog.txt', txt);
    }

    function copyToClipboard() {
      const text = shiftLog.map(s => `${s.date} | ${s.site} | ${formatTime(s.start)} - ${formatTime(s.end)} | ${s.total}`).join('\n');
      navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'), () => alert('Failed to copy.'));
    }

    function download(filename, text) {
      const a = document.createElement('a');
      a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      a.setAttribute('download', filename);
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function clearLogs() {
      if (confirm('Are you sure you want to permanently delete all logs? This cannot be undone.')) {
        shiftLog = [];
        localStorage.removeItem('shiftLog');
        renderShiftLog();
      }
    }

    loadData();
    applySettings();
    renderCurrentShiftStatus();
    renderShiftLog();
  </script>

</body>
</html>